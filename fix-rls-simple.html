<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® CORRE√á√ÉO URGENTE - Erro RLS Profiles</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .error-alert {
            background: #fee;
            border: 2px solid #f56565;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            color: #c53030;
        }
        
        .solution-box {
            background: #f0fff4;
            border: 2px solid #48bb78;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            color: #2f855a;
        }
        
        .sql-code {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.4;
            overflow-x: auto;
            margin: 15px 0;
            white-space: pre-wrap;
            border-left: 4px solid #4299e1;
        }
        
        .copy-btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px 5px;
            transition: all 0.2s;
        }
        
        .copy-btn:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }
        
        .step {
            background: #f7fafc;
            border-left: 4px solid #4299e1;
            padding: 20px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        
        h1 { color: #2d3748; text-align: center; }
        h2 { color: #4a5568; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        h3 { color: #2b6cb0; }
        
        .urgent { 
            animation: pulse 2s infinite;
            font-weight: bold;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® CORRE√á√ÉO URGENTE - Erro RLS</h1>
        
        <div class="error-alert">
            <h3>‚ùå ERRO IDENTIFICADO:</h3>
            <code>new row violates row-level security policy for table "profiles"</code>
            <p><strong>Causa:</strong> Pol√≠ticas RLS com recurs√£o infinita na tabela profiles</p>
        </div>

        <div class="solution-box">
            <h3>‚úÖ SOLU√á√ÉO IMEDIATA:</h3>
            <p>Execute os 2 scripts abaixo <strong>NA ORDEM</strong> no Supabase SQL Editor</p>
        </div>

        <div class="step">
            <h3>üßπ PASSO 1: Limpeza (Execute PRIMEIRO)</h3>
            <p>Este script remove todas as pol√≠ticas problem√°ticas:</p>
            <button class="copy-btn" onclick="copyCleanScript()">üìã Copiar Script de Limpeza</button>
            
            <div class="sql-code" id="cleanScript">-- SCRIPT DE LIMPEZA - Execute PRIMEIRO
-- Remove todas as pol√≠ticas RLS problem√°ticas

DROP POLICY IF EXISTS "Users can view own profile" ON profiles;
DROP POLICY IF EXISTS "Users can update own profile" ON profiles;
DROP POLICY IF EXISTS "Enable insert for authenticated users only" ON profiles;
DROP POLICY IF EXISTS "Admins can manage all profiles" ON profiles;
DROP POLICY IF EXISTS "Service role can manage all profiles" ON profiles;
DROP POLICY IF EXISTS "Users can view profiles" ON profiles;
DROP POLICY IF EXISTS "Users can update profiles" ON profiles;
DROP POLICY IF EXISTS "Admins can create profiles" ON profiles;
DROP POLICY IF EXISTS "Admins can delete profiles" ON profiles;
DROP POLICY IF EXISTS "Allow profile creation" ON profiles;
DROP POLICY IF EXISTS "Users can view own profile, admins view all" ON profiles;
DROP POLICY IF EXISTS "Users can update own profile, admins update all" ON profiles;
DROP POLICY IF EXISTS "Allow profile creation without recursion" ON profiles;
DROP POLICY IF EXISTS "Only admins can delete profiles" ON profiles;

-- Remove fun√ß√µes auxiliares
DROP FUNCTION IF EXISTS public.is_user_admin(UUID);
DROP FUNCTION IF EXISTS public.is_admin(UUID);

-- Garante que RLS est√° habilitado
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

SELECT 'Limpeza conclu√≠da! Execute agora o script de corre√ß√£o.' as status;</div>
        </div>

        <div class="step">
            <h3>üîß PASSO 2: Corre√ß√£o (Execute DEPOIS)</h3>
            <p>Este script cria as pol√≠ticas corretas sem recurs√£o:</p>
            <button class="copy-btn" onclick="copyFixScript()">üìã Copiar Script de Corre√ß√£o</button>
            
            <div class="sql-code" id="fixScript">-- SCRIPT DE CORRE√á√ÉO - Execute DEPOIS da limpeza
-- Cria pol√≠ticas RLS sem recurs√£o infinita

-- 1. Fun√ß√£o auxiliar sem recurs√£o (SECURITY DEFINER)
CREATE OR REPLACE FUNCTION public.is_user_admin(user_id UUID DEFAULT auth.uid())
RETURNS BOOLEAN AS $$
DECLARE
  user_role TEXT;
BEGIN
  SELECT role INTO user_role 
  FROM profiles 
  WHERE id = user_id;
  
  RETURN COALESCE(user_role = 'admin', false);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 2. Pol√≠ticas RLS corrigidas
CREATE POLICY "Users can view own profile, admins view all" ON profiles
  FOR SELECT USING (
    auth.uid() = id OR 
    public.is_user_admin(auth.uid()) OR
    current_setting('role') = 'service_role'
  );

CREATE POLICY "Users can update own profile, admins update all" ON profiles
  FOR UPDATE USING (
    auth.uid() = id OR 
    public.is_user_admin(auth.uid()) OR
    current_setting('role') = 'service_role'
  );

CREATE POLICY "Allow profile creation without recursion" ON profiles
  FOR INSERT WITH CHECK (
    auth.uid() = id OR 
    public.is_user_admin(auth.uid()) OR
    current_setting('role') = 'service_role'
  );

CREATE POLICY "Only admins can delete profiles" ON profiles
  FOR DELETE USING (
    public.is_user_admin(auth.uid()) OR
    current_setting('role') = 'service_role'
  );

-- 3. Fun√ß√£o para cria√ß√£o autom√°tica de profiles
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, full_name, role)
  VALUES (
    NEW.id,
    COALESCE(NEW.raw_user_meta_data->>'full_name', NEW.email),
    COALESCE(NEW.raw_user_meta_data->>'role', 'nurse')
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

SELECT 'Corre√ß√£o RLS aplicada com sucesso!' as status;</div>
        </div>

        <div class="step">
            <h3>üìã COMO EXECUTAR:</h3>
            <ol>
                <li><strong>Abra o Supabase Dashboard</strong> ‚Üí SQL Editor</li>
                <li><strong>Cole e execute</strong> o Script de Limpeza (Passo 1)</li>
                <li><strong>Aguarde</strong> a execu√ß√£o completar</li>
                <li><strong>Cole e execute</strong> o Script de Corre√ß√£o (Passo 2)</li>
                <li><strong>Teste</strong> a cria√ß√£o de usu√°rios</li>
            </ol>
        </div>

        <div class="solution-box">
            <h3>üéØ RESULTADO ESPERADO:</h3>
            <ul>
                <li>‚úÖ Erro de RLS ser√° resolvido</li>
                <li>‚úÖ Cria√ß√£o de usu√°rios funcionar√°</li>
                <li>‚úÖ Pol√≠ticas de seguran√ßa mantidas</li>
                <li>‚úÖ Sem recurs√£o infinita</li>
            </ul>
        </div>

        <div class="error-alert urgent">
            <h3>‚ö†Ô∏è IMPORTANTE:</h3>
            <p>Execute os scripts <strong>NA ORDEM CORRETA</strong>: Limpeza primeiro, depois Corre√ß√£o!</p>
        </div>
    </div>

    <script>
        function copyCleanScript() {
            const script = document.getElementById('cleanScript').textContent;
            navigator.clipboard.writeText(script).then(function() {
                alert('‚úÖ Script de Limpeza copiado!\n\nüî• Execute PRIMEIRO no Supabase SQL Editor');
            }, function(err) {
                console.error('Erro ao copiar: ', err);
                alert('‚ùå Erro ao copiar. Selecione manualmente o texto.');
            });
        }

        function copyFixScript() {
            const script = document.getElementById('fixScript').textContent;
            navigator.clipboard.writeText(script).then(function() {
                alert('‚úÖ Script de Corre√ß√£o copiado!\n\n‚ö° Execute DEPOIS da limpeza no Supabase SQL Editor');
            }, function(err) {
                console.error('Erro ao copiar: ', err);
                alert('‚ùå Erro ao copiar. Selecione manualmente o texto.');
            });
        }
    </script>
</body>
</html>